#!/bin/sh
# This is a shell script instead of a PHP script because we need to be able to set an ini option that ini_set() can't set

php -d phar.readonly=Off <<'EOF'
<?php
$target = 'vendor.phar';
$tmp = '/tmp/phar-install-tmp.phar';

// Delete first because otherwise we're just adding files to the archive
if (file_exists($target)) {
  echo "Deleting: $target\n";
  unlink($target);
}

$phar = new Phar($tmp);

$di = new RecursiveDirectoryIterator('vendor');
foreach (new RecursiveIteratorIterator($di) as $filename => $file) {
  if (
    preg_match('_/\.\.?$_', $filename) || # .. and .
    preg_match('_/\.git/_', $filename)    # .git
  ) {
    continue;
  }
  echo "Adding file: $filename\n";
  $phar->addFile($filename);
}

$rand = sprintf('%x', mt_rand());

$phar->setStub("<?php Phar::mapPhar('{$rand}'); include('phar://{$rand}/vendor/autoload.php'); __HALT_COMPILER();");

rename($tmp, $target);
EOF
